<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Engine HEX & QR Generator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  textarea {
    width: 100%;
    height: 100px;
    font-family: monospace;
    margin-bottom: 10px;
  }
  select, button {
    padding: 8px 12px;
    margin: 10px 0;
  }
  #qrCodeResult canvas {
    margin-top: 20px;
  }
  pre {
    background: #f0f0f0;
    padding: 10px;
    overflow-x: auto;
  }
</style>
</head>
<body>

<h2>Engine HEX & Data Matrix Generator</h2>

<label for="inputString">Paste input string here:</label>
<textarea id="inputString" placeholder="Paste your engine data string here..."></textarea>

<label for="engineCodeSelect">Engine Code (FA/FB/etc):</label>
<select id="engineCodeSelect">
  <option value="">-- Select Engine Code --</option>
  <option value="FA">FA</option>
  <option value="FB">FB</option>
  <option value="BA">BA</option>
  <option value="BEA">BEA</option>
</select>

<br />

<button onclick="identifyEngine()">Check</button>

<div id="engineInfo" style="margin-top: 20px; font-weight: bold;"></div>

<div id="results" style="margin-top: 10px;"></div>

<div id="qrCodeResult"></div>

<script src="https://unpkg.com/bwip-js/dist/bwip-js-min.js"></script>
<script>
  // Sanitize input (remove non-alphanumeric and uppercase)
  function sanitizeInput(str) {
    return str.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
  }

  // Calculate checksum for HEX record
  function calculateChecksum(data) {
    let sum = 0;
    for (let i = 0; i < data.length; i += 2) {
      const byte = parseInt(data.substring(i, i + 2), 16);
      sum += byte;
    }
    const checksum = (256 - (sum % 256)) % 256;
    return checksum.toString(16).toUpperCase().padStart(2, '0');
  }

  // Extract serial number based on engine type and your rules
  function extractSerialNumber(inputString, engineType) {
    const RS = String.fromCharCode(30);
    const GS = String.fromCharCode(29);
    const prefix = `[)>${RS}06${GS}1T`;

    if (engineType === 'Lion') {
      const prefixIndex = inputString.indexOf(prefix);
      if (prefixIndex !== -1) {
        // serial number is what follows the prefix until some end or full rest
        return inputString.substring(prefixIndex + prefix.length).trim();
      } else {
        alert("Lion engine prefix not found.");
        return null;
      }
    } else if (engineType === 'Panther') {
      if (inputString.startsWith('CSEPA')) {
        return inputString.substring(0, 16).trim();
      } else {
        const prefixIndex = inputString.indexOf(prefix);
        if (prefixIndex !== -1) {
          return inputString.substring(prefixIndex + prefix.length).trim();
        } else {
          alert("Panther engine prefix not found.");
          return null;
        }
      }
    }
    return null;
  }

  // Main engine detection & display function
  function identifyEngine() {
    const inputString = document.getElementById('inputString').value.trim();
    const resultsDiv = document.getElementById('results');
    const engineInfoDiv = document.getElementById('engineInfo');

    const pantherMarkers = ['ARA', 'AMA', 'ANA', 'CB', 'DB', 'LB', 'MB'];
    const lionMarkers = ['FA', 'FB', 'BA', 'BEA'];

    let engineType = null;
    let segments = [];

    // Detect Panther
    for (const marker of pantherMarkers) {
      if (inputString.includes(marker)) {
        engineType = 'Panther';
        const markerIndex = inputString.indexOf(marker);
        let relevantPart = inputString.substring(markerIndex + marker.length);
        relevantPart = relevantPart.replace(new RegExp(String.fromCharCode(29), 'g'), '');
        const allSegments = relevantPart.match(/.{16}/g) || [];
        segments = allSegments.slice(0, 4);
        if (segments.length !== 4 || !segments.every(seg => seg.length === 16)) {
          resultsDiv.innerHTML = "Invalid Panther input: Requires 4 segments of 16 characters each.";
          return;
        }
        break;
      }
    }

    // Detect Lion if not Panther
    if (!engineType) {
      for (const marker of lionMarkers) {
        if (inputString.includes(marker)) {
          engineType = 'Lion';
          const zIndex = inputString.indexOf('Z');
          if (zIndex !== -1) {
            const remainingString = inputString.substring(zIndex + 1);
            const allSegments = remainingString.match(/.{16}/g) || [];
            segments = allSegments.slice(0, 6);
            if (segments.length !== 6 || !segments.every(seg => seg.length === 16)) {
              resultsDiv.innerHTML = "Invalid Lion input: Requires 6 segments of 16 characters each.";
              return;
            }
          } else {
            resultsDiv.innerHTML = "Invalid Lion input: 'Z' not found.";
            return;
          }
          break;
        }
      }
    }

    if (!engineType) {
      engineInfoDiv.innerHTML = '';
      resultsDiv.innerHTML = "Engine type not identified (no valid markers found).";
      return;
    }

    const serialNumber = extractSerialNumber(inputString, engineType);
    if (!serialNumber) {
      resultsDiv.innerHTML = "Serial number could not be extracted.";
      return;
    }

    engineInfoDiv.innerHTML = `Engine Type: ${engineType} (Valid)<br>Serial Number: ${serialNumber}<br>Segments with Prefixes:`;

    // Generate HEX output display
    const segmentPrefixes = [
      ':08000000', ':08000800', ':08001000',
      ':08001800', ':08002000', ':08002800'
    ];

    let output = '';
    output += engineType === 'Lion' ? ':020000040000FA\n' : ':020000040001F9\n';
    segments.forEach((segment, index) => {
      const prefix = segmentPrefixes[index] || ':08000000';
      const dataRecord = `${prefix}${segment}`;
      const checksum = calculateChecksum(dataRecord.slice(1));
      output += `${dataRecord}${checksum}\n`;
    });
    output += ':00000001FF';

    resultsDiv.innerHTML = `<pre>${output}</pre>`;

    // Call QR code generation with extracted data
    generateQRCode(serialNumber, engineType, segments);
  }

  // Generate Data Matrix QR code using bwip-js
  function generateQRCode(serialNumber, engineType, segments) {
    const RS = String.fromCharCode(30);
    const GS = String.fromCharCode(29);
    const EOT = String.fromCharCode(4);
    const prefix = '[)>' + RS + '06' + GS + '1T';

    if (!serialNumber || !segments) {
      alert("Missing data for QR code generation.");
      return;
    }

    const expectedSegments = engineType === 'Lion' ? 6 : 4;
    if (segments.length !== expectedSegments) {
      alert(`Incorrect number of segments for ${engineType}. Expected ${expectedSegments}.`);
      return;
    }

    // Sanitize and join all segments
    let segmentsData = segments.map(sanitizeInput).join('');
    const engineCode = document.getElementById('engineCodeSelect').value || '';

    let faFbPortion = ` ${engineCode}`;

    let qrData = `${prefix}${serialNumber}      RB3Q 6007${faFbPortion}    ${GS}9SIQA.V6.1${GS}12Z${segmentsData}${RS}${EOT}`;

    const qrCodeResult = document.getElementById('qrCodeResult');
    qrCodeResult.innerHTML = '';
    const canvas = document.createElement('canvas');
    qrCodeResult.appendChild(canvas);

    try {
      bwipjs.toCanvas(canvas, {
        bcid: 'datamatrix',
        text: qrData,
        encoding: 'c40',
        rows: 52,
        columns: 52,
        ecc: 'ecc200',
        parse: false,
        macro: false,
        scale: 5,
        padding: 5
      });
    } catch (e) {
      alert(`Error in generating Data Matrix: ${e.message}`);
    }
  }
</script>

</body>
</html>
