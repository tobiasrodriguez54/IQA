<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IQA Checksum Data Matrix Generator</title>
<script src="https://cdn.jsdelivr.net/npm/bwip-js/dist/bwip-js-min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
    }
    h1 { text-align:center; }
    .container {
        max-width: 600px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px #ccc;
    }
    label, select, textarea, input, button {
        width: 100%;
        margin-top: 10px;
        font-size: 1rem;
    }
    button {
        margin-top: 20px;
        padding: 10px;
        cursor: pointer;
    }
    #qrResult {
        margin-top: 20px;
        text-align: center;
    }
</style>
</head>
<body>
<div class="container">
    <h1>IQA Checksum Data Matrix Generator</h1>

    <label>
      Engine Type:
      <select id="engineType" onchange="populateEngineCodes()">
        <option value="panther" selected>Panther</option>
        <option value="lion">Lion</option>
      </select>
    </label>

    <label>
      Engine Code:
      <select id="engineCode"></select>
    </label>

    <label>
      Raw Input String:
      <textarea id="rawInput" rows="6" placeholder="Paste full input string here"></textarea>
    </label>

    <button onclick="generateDataMatrix()">Generate Data Matrix</button>

    <div id="qrResult"></div>
</div>

<script>
// Populate engine codes depending on type
function populateEngineCodes() {
    const engineType = document.getElementById('engineType').value;
    const engineCodeSelect = document.getElementById('engineCode');
    engineCodeSelect.innerHTML = '';

    let codes = [];
    if (engineType === 'lion') {
        codes = ['FA', 'FB'];
    } else {
        codes = ['ARA', 'AMA', 'ANA', 'CB', 'DB', 'LB', 'MB'];
    }
    codes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        engineCodeSelect.appendChild(opt);
    });
}

// Extract serial number from raw string according to rules
function extractSerialNumber(raw, engineType) {
    if (!raw) return null;

    if (engineType === 'panther' && raw.startsWith('CSEPA')) {
        // Serial is first 16 chars including CSEPA
        return raw.substr(0, 16);
    }

    // Otherwise, find first 'T' and take next 16 chars after it
    const tIndex = raw.indexOf('T');
    if (tIndex === -1 || raw.length < tIndex + 1 + 16) {
        return null;
    }
    return raw.substr(tIndex + 1, 16);
}

// Parse segments of 16 chars from the input data part
// Expected lines depends on engine type (4 Panther, 6 Lion)
function parseSegments(rawText, expectedCount) {
    if (!rawText) return null;

    // Split lines, trim, filter empties
    const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    // We want exactly expectedCount lines with segment data (excluding header/footer lines)
    if (lines.length < 2) return null;

    const middleLines = lines.slice(1, lines.length - 1);
    if (middleLines.length !== expectedCount) return null;

    // Extract 16 chars from position 8 (0-based) for each middle line
    const segments = middleLines.map(line => {
        if (line.length < 24) return null; // must have at least 8 + 16 chars
        return line.substr(8, 16);
    });

    if (segments.some(s => s === null)) return null;

    return segments;
}

function sanitizeText(text) {
    // Remove non-printable ASCII chars except space (32-126)
    return text.replace(/[^\x20-\x7E]/g, '');
}

function generateDataMatrix() {
    const RS = String.fromCharCode(30);
    const GS = String.fromCharCode(29);
    const EOT = String.fromCharCode(4);

    const engineType = document.getElementById('engineType').value;
    const engineCode = document.getElementById('engineCode').value;
    const rawInput = document.getElementById('rawInput').value;

    // Extract serial number based on rules
    const serialNumber = extractSerialNumber(rawInput, engineType);
    if (!serialNumber || serialNumber.length !== 16) {
        alert('Error: Could not extract valid 16-character serial number based on rules.');
        return;
    }

    // Parse segment data: the input includes the whole string, but we expect segment data in lines after header/footer
    // Extract segment data from the rawInput (assuming pasted whole string), so let's extract text after GS char '' (char 29) + "12Z"
    // But for simplicity, let's assume user pastes the segment lines only in rawInput or full string and we split by lines below.

    // We'll try to find the segment lines by splitting input by newlines; if none, try to parse from raw string after "12Z"

    // Detect number of expected segments
    const expectedSegments = engineType === 'lion' ? 6 : 4;

    // Try parsing segments from lines:
    let segments = parseSegments(rawInput, expectedSegments);

    if (!segments) {
        alert(`Error: Could not parse ${expectedSegments} segments of 16 characters each from the input lines.`);
        return;
    }

    // Sanitize segments and join
    const segmentsData = segments.map(sanitizeText).join('');

    // Construct IQA Data Matrix string exactly as your spec:
    // Format:
    // [)> RS 06 GS 1T + serialNumber + "      RB3Q 6007" + " " + engineCode + "    " + GS + "9SIQA.V6.1" + GS + "12Z" + segmentsData + RS + EOT

    // Note: spaces exactly as shown, total 6 spaces after serialNumber before RB3Q

    const qrData = '[)>' + RS + '06' + GS + '1T' +
        serialNumber +
        '      ' + // 6 spaces
        'RB3Q 6007' +
        ' ' + engineCode +
        '    ' + // 4 spaces
        GS +
        '9SIQA.V6.1' +
        GS +
        '12Z' +
        segmentsData +
        RS +
        EOT;

    // Show serial number for confirmation
    console.log('Serial Number:', serialNumber);
    console.log('Final QR Data:', qrData);

    // Generate barcode
    const qrResult = document.getElementById('qrResult');
    qrResult.innerHTML = ''; // clear old

    const canvas = document.createElement('canvas');
    qrResult.appendChild(canvas);

    try {
        bwipjs.toCanvas(canvas, {
            bcid: 'datamatrix',
            text: qrData,
            encoding: 'c40',
            scale: 5,
            padding: 5,
            ecc: 'ecc200',
        });
    } catch (e) {
        alert('Error generating Data Matrix: ' + e.message);
    }
}

// Initialize engine codes on load
populateEngineCodes();
</script>
</body>
</html>
